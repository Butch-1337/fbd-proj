<!doctype html>
<html lang="ru">
	<head>
		<link rel="stylesheet" href="css/main.css" />	
	</head>
	<body>
	<div id = "main"> 
		<div id = "menu">
			<span>Blocks<span>
			<button class="menu-button" data-action="switch">1/0</button>
			<button class="menu-button" data-action="and"> & </button>
			<button class="menu-button" data-action="or"> OR </button>
			<button class="menu-button" data-action="xor"> XOR </button>
		</div>
		<div id="content">	
		  <div class="ui-draggable" id="block1">
			<div class="block-name"> 1/0 </div>
			<div class="out" id="b1out" data-action="startPoint">0</div>
			<button onclick="init('b1out')">1/0</button>
		  </div>
		  <div class="ui-draggable" id="block2">
			<div class="block-name"> 1/0 </div>
			<div class="out" id="b2out" data-action="startPoint">0</div>
			<button onclick="init('b2out')" >1/0</button>
		  </div>
		  <div class="ui-draggable" id="block3">
			<div class="block-name"> & </div>
			<div class="in in1" id="b3in1" data-action="endPoint"></div>
			<div class="in in2" id="b3in2" data-action="endPoint"></div>
			<div class="out" id="b3out" data-action="startPoint"></div>
		  </div>
		</div>
	</div>
	</body>
		<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script> -->
		<script src="lib/jquery-1.5.min.js"></script>
		<script src="lib/jquery-ui.min.js"></script>
		<script src="lib/arrows.1.0.0.js"></script>
		<script>
				  // Определим «общего родителя», на котором будут рисоваться стрелки (создаваться холст – canvas)
		  var arrowsDrawer1 = $cArrows('#content');
		  var arrowsDrawer2 = $cArrows('#content');
		  var arrowsArr = [];
		  var blocksArr = [];
		  var oId;
		  var p2;
		
			function Menu(elem) {
				var idnumber = 4;
				
				this.switch = function() {
				  createBlock("sw", idnumber);
				  dragndrop();
				  idnumber++;
				};
				
				this.and = function() {
				  createBlock("and", idnumber);
				  dragndrop();
				  idnumber++;
				};
				
				this.or = function() {
				  createBlock("or", idnumber);
				  dragndrop();
				  idnumber++;
				};
				
				this.xor = function() {
				  createBlock("xor", idnumber);
				  dragndrop();
				  idnumber++;
				};
				
				var self = this;

				elem.onclick = function(e) {
				  var target = e.target;
				  var action = target.getAttribute('data-action');
				  if (action) {
					self[action]();
				  }
				};
		    }
			
			new Menu(menu);
			
			function ContentClick(elem) {
								
				this.startPoint = function() {
				  event = event || window.event;
				  oId = event.target.id;
				};
				
				this.endPoint = function() {
				  event = event || window.event;
				  p2 = event.target.id;
				  var arrowsDrawerN = $cArrows('#content');	  
				  arrowsDrawerN.arrow('#'+oId, '#'+p2,
				  { arrow: { connectionType: 'side', sideFrom: 'right', sideTo: 'left'}});
				  arrowsArr.push([oId, p2, arrowsDrawerN]);
				  document.getElementById(p2).innerHTML =
				  document.getElementById(oId).innerHTML;
				};
				
				var self = this;

				elem.onclick = function(e) {
				  var target = e.target;
				  var action = target.getAttribute('data-action');
				  if (action) {
					self[action]();
				  }
				};
		    }
			
			new ContentClick(content);
			
			function createBlock(blockType, idn) {
				switch(blockType) {
				  case "sw":
					var div = document.createElement('div'),
						div1 = document.createElement('div'),
						div2 = document.createElement('div');
						btn = document.createElement('button');
					div.className = "ui-draggable";
					div.id = "block" + idn;
					div1.className = "block-name";
					div1.innerHTML = "1/0";
					div2.className = "out";
					div2.id = "b" + idn + "out";
					div2.setAttribute("data-action","startPoint");
					div2.innerHTML = 0;
					btn.innerHTML = "1/0";
					btn.setAttribute("onclick","init('" + div2.id + "')");
					document.getElementById("content").appendChild(div);
					document.getElementById("block"+idn).appendChild(div1);
					document.getElementById("block"+idn).appendChild(div2);
					document.getElementById("block"+idn).appendChild(btn);
				  break;				  
				  case "and":
					var div = document.createElement('div'),
						div1 = document.createElement('div'),
						div2 = document.createElement('div');
						div3 = document.createElement('div');
						div4 = document.createElement('div');
					div.className = "ui-draggable";
					div.id = "block" + idn;
					div1.className = "block-name";
					div1.innerHTML = "&";
					div2.className = "in in1";
					div2.id = "b" + idn + "in1";
					div2.setAttribute("data-action","endPoint");
					div3.className = "in in2";
					div3.id = "b" + idn + "in2";
					div3.setAttribute("data-action","endPoint");
					div4.className = "out";
					div4.id = "b" + idn + "out";
					div4.setAttribute("data-action","startPoint");
					document.getElementById("content").appendChild(div);
					document.getElementById("block"+idn).appendChild(div1);
					document.getElementById("block"+idn).appendChild(div2);
					document.getElementById("block"+idn).appendChild(div3);
					document.getElementById("block"+idn).appendChild(div4);
					//var a = new andbl(div4.id, div2.id, div3.id);
					blocksArr.push([andbl, div4.id, div2.id, div3.id]);
					//var x = document.getElementById(div2.id);
					//div2.addEventListener("DOMCharacterDataModified",console.log("111"));
					observer.observe(div, options);
				  break;
				  case "or":
					var div = document.createElement('div'),
						div1 = document.createElement('div'),
						div2 = document.createElement('div');
						div3 = document.createElement('div');
						div4 = document.createElement('div');
					div.className = "ui-draggable";
					div.id = "block" + idn;
					div1.className = "block-name";
					div1.innerHTML = "OR";
					div2.className = "in in1";
					div2.id = "b" + idn + "in1";
					div2.setAttribute("data-action","endPoint");
					div3.className = "in in2";
					div3.id = "b" + idn + "in2";
					div3.setAttribute("data-action","endPoint");
					div4.className = "out";
					div4.id = "b" + idn + "out";
					div4.setAttribute("data-action","startPoint");
					document.getElementById("content").appendChild(div);
					document.getElementById("block"+idn).appendChild(div1);
					document.getElementById("block"+idn).appendChild(div2);
					document.getElementById("block"+idn).appendChild(div3);
					document.getElementById("block"+idn).appendChild(div4);
				  break;
				  case "xor":
					var div = document.createElement('div'),
						div1 = document.createElement('div'),
						div2 = document.createElement('div');
						div3 = document.createElement('div');
						div4 = document.createElement('div');
					div.className = "ui-draggable";
					div.id = "block" + idn;
					div1.className = "block-name";
					div1.innerHTML = "XOR";
					div2.className = "in in1";
					div2.id = "b" + idn + "in1";
					div2.setAttribute("data-action","endPoint");
					div3.className = "in in2";
					div3.id = "b" + idn + "in2";
					div3.setAttribute("data-action","endPoint");
					div4.className = "out";
					div4.id = "b" + idn + "out";
					div4.setAttribute("data-action","startPoint");
					document.getElementById("content").appendChild(div);
					document.getElementById("block"+idn).appendChild(div1);
					document.getElementById("block"+idn).appendChild(div2);
					document.getElementById("block"+idn).appendChild(div3);
					document.getElementById("block"+idn).appendChild(div4);
				  break;
				}
			
			}
			
			var callback = function(){
				for (var i = 0; i < blocksArr.length; i++) {
					//var bl = new blocksArr[i][0](blocksArr[i][1],blocksArr[i][2],blocksArr[i][3]);
					//console.log(blocksArr);
					blocksArr[i][0](blocksArr[i][1],blocksArr[i][2],blocksArr[i][3]);
					chColor(blocksArr[i][1]);
					chIn(blocksArr[i][1]);
				}
			};
			var observer = new MutationObserver(callback);
			var  options = {
				'childList': true,
				'subtree': true,
				'characterData': true
			}
			
			
			function andbl(out,id1,id2) {
				var bv1 = document.getElementById(id1).innerHTML;
				var bv2 = document.getElementById(id2).innerHTML;
				document.getElementById(out).innerHTML = Number(bv1) && Number(bv2);
			}
			
			function chColor(outId) {
				var bc = document.getElementById(outId);
				var bv = document.getElementById(outId).innerHTML;		
				if (bv == 0) {
				  bc.style.background = 'red';
				  for (var i = 0; i < arrowsArr.length; i++) {
					if (outId == arrowsArr[i][0]) {
					 arrowsArr[i][2].updateOptions(
				     { render: {strokeStyle:'red'}})
				     arrowsArr[i][2].redraw();
					} 
				  }
				}
				else {
				  bc.style.background = 'green';
				  for (var i = 0; i < arrowsArr.length; i++) {
					if (outId == arrowsArr[i][0]) {
					 arrowsArr[i][2].updateOptions(
				     { render: {strokeStyle:'green'}})
				     arrowsArr[i][2].redraw();
					} 
				  }
				} 
			}	  
		  
		    function init(outId){
			  var bv = document.getElementById(outId).innerHTML;
			  if (bv == 0) {
				  bv = 1;
			  }
			  else {
				bv = 0;
			  }				
			  document.getElementById(outId).innerHTML = bv;
			  chColor(outId);
			  
			  chIn(outId);
			  /*var p, idx;
			  for (var i = 0; i < arrowsArr.length; i++) {
				 if(arrowsArr[i].indexOf(outId) == 0) p = i;
				}
			  idx = arrowsArr[p][1];
			  document.getElementById(idx).innerHTML = bv;
			  chColor(idx);*/
			  			  
		    }
		  
		    function chIn(outId) {
				var bv = document.getElementById(outId).innerHTML;
				var p, idx;
				for (var i = 0; i < arrowsArr.length; i++) {
					if(arrowsArr[i].indexOf(outId) == 0) {
						p = i;
						idx = arrowsArr[p][1];
						document.getElementById(idx).innerHTML = bv;
						chColor(idx);	
					}
				}
			  		  		
		    }
		    
		     
		  // Рисуем стрелки .arrow(from, to)
		  /*arrowsDrawer1.arrow('#block1 .out', '#block3 .in1',
		  { arrow: { connectionType: 'side', sideFrom: 'right', sideTo: 'left'}});
		  arrowsDrawer2.arrow('#b2out', '#b3in2',
		  { arrow: { connectionType: 'side', sideFrom: 'right', sideTo: 'left'}});*/
		  
		  // Перерисовка при перемещении с jQuery Ui
		  function dragndrop() {
			$( "#content .ui-draggable" ).draggable({
			  containment: "#content",
			  scroll: false,
			  cursor: 'move',
			  drag: function( event, ui ) {
				arrowsDrawer1.redraw();
				arrowsDrawer2.redraw();
				for (var i = 0; i < arrowsArr.length; i++) {
				 arrowsArr[i][2].redraw();
				}
			  }
			});			
		  }
		  
		  dragndrop();
		  
		</script>
</html>

